<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¥‡è¹Ÿå¿ƒéˆï½œå…¬å‘Šå°å¹«æ‰‹</title>
  <style>
    :root{
      --bg:#f7f2e8; --card:#fff7e8; --ink:#1f2937; --muted:#6b7280;
      --line:#e7d7b8; --btn:#1f2937; --btn2:#6b7280; --ok:#0f766e; --warn:#b45309;
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", Arial, sans-serif;
    }
    body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--sans);}
    .wrap{max-width:1100px;margin:0 auto;padding:18px;}
    h1{margin:6px 0 4px;font-size:24px;}
    p{margin:0;color:var(--muted);line-height:1.6}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:14px;margin-top:14px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    label{display:block;font-weight:800;margin:10px 0 6px;}
    input[type="text"], input[type="date"], textarea, select{
      width:100%;box-sizing:border-box;border:1px solid var(--line);border-radius:12px;
      padding:10px 12px;font-size:15px;background:#fff;
    }
    textarea{min-height:86px;resize:vertical;}
    .small{font-size:13px;color:var(--muted);margin-top:6px}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    button{
      border:0;border-radius:999px;padding:10px 14px;font-weight:900;cursor:pointer;
      background:var(--btn);color:#fff;
    }
    button.secondary{background:var(--btn2)}
    button.ghost{background:transparent;color:var(--btn);border:1px solid var(--line)}
    button.ok{background:var(--ok)}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:900;font-size:12px}
    .badge.ok{background:#d1fae5;color:#065f46}
    .badge.warn{background:#ffedd5;color:#9a3412}
    .mono{font-family:var(--mono);font-size:13px;line-height:1.5}
    pre{margin:0;white-space:pre-wrap;word-break:break-word;background:#0b1220;color:#e5e7eb;
      border-radius:14px;padding:12px;border:1px solid #111827;}
    .listCard{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:10px}
    .noticeHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .noticeTitle{font-weight:1000;font-size:16px}
    .pill{border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:12px;font-weight:900;color:#7a5e2a;background:#fff}
    .meta{font-size:13px;color:var(--muted);margin-top:4px}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .hint{margin-top:10px;font-size:13px;color:var(--muted)}
    .danger{color:#9a3412;font-weight:900}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <div class="wrap">
     <h1>å¥‡è¹Ÿå¿ƒéˆï½œå…¬å‘Šå°å¹«æ‰‹</h1>
    <p>æŠŠæƒ³åˆ†äº«çš„æ¶ˆæ¯ï¼Œæº«æŸ”å¯«ä¸‹ä¾† â†’ è‡ªå‹•æ•´ç†æˆ <span class="mono">mm-notices.json</span> â†’ ä¸€éµè¤‡è£½ â†’ ä½ å†è²¼åˆ° GitHub çš„ <span class="mono">mm-notices.json</span> è¦†è“‹å³å¯ã€‚</p>

    <div class="grid">
      <!-- Left: Form -->
      <div class="card">
        <div class="row">
          <div>
            <label>schemaVersion</label>
            <input id="schemaVersion" type="text" value="1" />
            <div class="small">ä¿æŒ 1 å³å¯ï¼ˆèˆ‡ç›®å‰å…¬å‘Šæ ¼å¼ä¸€è‡´ï¼‰ã€‚</div>
          </div>
          <div>
            <label>æŒ‰ä¸‹æ™‚è‡ªå‹•å¯«å…¥ï¼ˆå°ç£æ™‚é–“ +08:00ï¼‰ã€‚</label>
            <input id="generatedAt" type="text" placeholder="æŒ‰ã€ç”¢ç”Ÿ JSONã€æ™‚è‡ªå‹•å¡«å…¥" disabled />
            <div class="small">æ™‚å€å›ºå®š +08:00ï¼ˆå°ç£ï¼‰ã€‚</div>
          </div>
        </div>

        <div class="hr"></div>

        <label>å…¬å‘Š IDï¼ˆå”¯ä¸€è­˜åˆ¥ï¼‰</label>
        <input id="id" type="text" placeholder="ä¾‹å¦‚ï¼šboard_2026-01-24_01ï¼ˆå»ºè­°ç”¨æ—¥æœŸï¼‹æµæ°´è™Ÿï¼‰" />
        <button
          type="button"
          class="ghost"
          style="margin-top:6px"
          id="btnAutoId">
           âœ¨ è‡ªå‹•ç”¢ç”Ÿå…¬å‘Š ID
        </button>

        <div class="small">ğŸŒ¿ å°æé†’ï¼šæ¯ä¸€æ¬¡ã€Œæ–°çš„å…¬å‘Šã€éƒ½è«‹ç”¨æ–°çš„ idï¼ˆé€™æœƒè®“ç´…é»åˆ¤æ–·æ›´ç©©ï¼‰ã€‚</div>

        <label>æ¨™é¡Œ title</label>
        <input id="title" type="text" placeholder="ä¾‹å¦‚ï¼šå…¬å‘Šï½œå¥‡è¹Ÿå¿ƒéˆ APP é–‹å¼µäº†" />

        <div class="row">
          <div>
            <label>ç‰ˆæœ¬ version</label>
            <input id="version" type="text" placeholder="ä¾‹å¦‚ï¼šv1.0.0" value="v1.0.0" />
            <div class="small">å¯ä»¥å¡« App ç‰ˆæœ¬ï¼ˆè®“å¤§å®¶çŸ¥é“é€™å‰‡å…¬å‘Šå°æ‡‰å“ªå€‹ç‰ˆæœ¬ï¼‰ã€‚</div>
          </div>
          <div>
            <label>æ—¥æœŸ date</label>
            <input id="date" type="date" />
            <div class="small">å»ºè­°å¡«ã€Œå…¬å‘Šç™¼å¸ƒæ—¥ã€ï¼ˆYYYY-MM-DDï¼‰ã€‚</div>
          </div>
        </div>

        <label style="margin-top:12px;">
          <input id="pinned" type="checkbox" />
          ç½®é ‚ pinnedï¼ˆå‹¾é¸ = ç½®é ‚ï¼‰ï¼ˆæƒ³è®“å®ƒè¢«å¤§å®¶å…ˆçœ‹åˆ°å°±å‹¾é¸ï¼‰
        </label>

        <label>æ‘˜è¦ summary</label>
        <textarea id="summary" placeholder="ä¸€æ®µçŸ­æ‘˜è¦ï¼ˆå¯é¡¯ç¤ºåœ¨åˆ—è¡¨ä¸Šï¼‰"></textarea>

        <label>é‡é» bulletsï¼ˆæ¯è¡Œä¸€é»ï¼‰</label>
        <textarea id="bullets" placeholder="ä¾‹å¦‚ï¼š
          æ–°åŠŸèƒ½å·²ä¸Šç·šï¼Œæ­¡è¿æ›´æ–°é«”é©—
          æœ¬é€±è®€æ›¸æœƒï¼šé€±å…­æ™šä¸Š 8 é»
          æœ‰ä»»ä½•éœ€è¦ï¼Œä¹Ÿæ­¡è¿å›ä¾†çœ‹çœ‹"></textarea>
        <div class="small">æ¯è¡Œæœƒè‡ªå‹•è½‰æˆ bullets é™£åˆ—ã€‚</div>

        <label>è©³ç´°å…§å®¹ details</label>
        <textarea id="details" placeholder="æƒ³å¤šèªªä¸€é»ä¹Ÿå¯ä»¥æ”¾é€™è£¡ï¼ˆå±•é–‹å¾Œé¡¯ç¤ºï¼‰"></textarea>

        <div class="btns">
          <button id="btnAdd" class="ok">åŠ å…¥å…¬å‘Šåˆ°æ¸…å–®</button>
          <button id="btnReset" class="ghost" type="button">æ¸…ç©ºè¡¨å–®</button>
          <button id="btnSeed" class="secondary" type="button">ç”¨ç¯„ä¾‹å¡«å…¥</button>
        </div>

        <div class="hint">
          âœ… ä½ å¯ä»¥å…ˆåŠ å…¥å¤šå‰‡å…¬å‘Šåˆ°å³å´æ¸…å–®ï¼Œå†ä¸€æ¬¡ç”¢ç”Ÿ JSONã€‚<br/>
          <span class="danger">é‡è¦ï¼š</span>æ–°å¢å…¬å‘Šè¦è§¸ç™¼ç´…é»ï¼Œæœ€ç©©çš„æ–¹æ³•å°±æ˜¯ã€Œæ›æ–° id + æ›´æ–° dateã€ã€‚
        </div>
      </div>

      <!-- Right: Output -->
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div>
            <div style="font-weight:1000;font-size:16px;">å…¬å‘Šæ¸…å–®ï¼ˆå³å°‡è¼¸å‡ºåˆ° mm-notices.jsonï¼‰</div>
            <div class="small">æ’åºå»ºè­°ï¼šç½®é ‚åœ¨å‰ï¼Œæ—¥æœŸæ–°åœ¨å‰ï¼ˆä½ å¯æ‹–æ›³æ’åºç¬¬äºŒç‰ˆå†åŠ ï¼‰ã€‚</div>
          </div>
          <div id="status" class="badge warn">å°šæœªç”¢ç”Ÿ JSON</div>
        </div>

         <div class="listCard" style="margin-top:12px;">
  <div class="noticeHead">
    <div class="noticeTitle">è¼‰å…¥èˆŠç‰ˆ mm-notices.jsonï¼ˆå¯ä¿ç•™/åˆªé™¤å†æ–°å¢ï¼‰</div>
    <span class="pill">é¸æ“‡è¦†è“‹æˆ–åˆä½µ</span>
  </div>

  <div class="small" style="margin-top:8px;">
    ä½ å¯ä»¥ã€Œè²¼ä¸ŠèˆŠ JSONã€æˆ–ã€Œä¸Šå‚³æª”æ¡ˆã€è¼‰å…¥åˆ°å³å´æ¸…å–®ï¼Œæ¥è‘—å°±èƒ½åˆªæ‰ä¸è¦çš„èˆŠè¨Šæ¯ï¼Œå†å¾å·¦é‚ŠåŠ å…¥æ–°å…¬å‘Šã€‚
  </div>

  <label style="margin-top:10px;">è¼‰å…¥æ¨¡å¼</label>
  <select id="loadMode">
    <option value="replace">è¦†è“‹ï¼šç”¨èˆŠ JSON å–ä»£ç›®å‰æ¸…å–®</option>
    <option value="merge">åˆä½µï¼šæŠŠèˆŠ JSON åˆä½µé€²ç›®å‰æ¸…å–®ï¼ˆåŒ id æœƒä¿ç•™èˆŠ JSONï¼‰</option>
  </select>

  <label style="margin-top:10px;">è²¼ä¸ŠèˆŠç‰ˆ JSONï¼ˆmm-notices.json å…§å®¹ï¼‰</label>
  <textarea id="oldJson" placeholder="æŠŠèˆŠç‰ˆ mm-notices.json å…¨éƒ¨è²¼åœ¨é€™è£¡"></textarea>

   <label style="margin-top:10px;">ğŸ” ç”¨ç¶²å€è¼‰å…¥ç·šä¸Š mm-notices.json</label>
<div style="display:flex; gap:8px; align-items:center;">
  <input
    id="oldJsonUrl"
    type="url"
    style="flex:1;"
    placeholder="è²¼ä¸Š https://miracle-mind.org/mm-notices.json æˆ– GitHub raw é€£çµ"
  />
  <button id="btnLoadFromUrl" type="button" class="secondary">ä¸€éµè¼‰å…¥</button>
  <button id="btnSaveUrl" type="button" class="ghost" title="è¨˜ä½é€™å€‹ç¶²å€">
    ğŸ“Œ
  </button>
  <button id="btnClearUrl" type="button" class="ghost" title="æ¸…é™¤è¨˜ä½çš„ç¶²å€">ğŸ§¹</button>
</div>
<div class="small" style="margin-top:6px;">
  ğŸ“Œ å¯å°‡å¸¸ç”¨ç¶²å€å­˜åˆ°ç€è¦½å™¨ï¼Œä¸‹æ¬¡é–‹å•Ÿç·¨è¼¯å™¨æœƒè‡ªå‹•å¸¶å…¥ã€‚
</div>

<div class="small" style="margin-top:6px;">
  è‹¥é‡åˆ° CORSï¼ˆè·¨åŸŸï¼‰é™åˆ¶ï¼Œç³»çµ±æœƒè‡ªå‹•æ”¹ç”¨å®‰å…¨çš„ã€Œæ–‡å­—è½‰è®€ã€æ–¹å¼è¼‰å…¥ã€‚
</div>
 

  <div class="btns" style="margin-top:10px;">
    <button id="btnLoadOld" type="button" class="secondary">è¼‰å…¥ï¼ˆè²¼ä¸Šå…§å®¹ï¼‰</button>
    <button id="btnLoadFromFile" type="button" class="ghost">å¾æª”æ¡ˆè¼‰å…¥</button>
    <input id="fileOldJson" type="file" accept="application/json" style="display:none;" />
  </div>

  <div class="small" style="margin-top:8px;">
    å°æé†’ï¼šè¼‰å…¥å¾Œä½ å¯ä»¥ç”¨å³å´æ¯å‰‡å…¬å‘Šçš„ã€Œåˆªé™¤ã€æŠŠé‚£ 1 æ¢ç§»é™¤ï¼Œå†å¾å·¦å´åŠ å…¥æ–°å…¬å‘Šå³å¯ã€‚
  </div>
</div>


        <div id="noticeList"></div>

        <div class="btns">
          <button id="btnGenerate" type="button">ç”¢ç”Ÿ JSON</button>
          <button id="btnCopy" class="ok" type="button" disabled>ä¸€éµè¤‡è£½ JSON</button>
          <button id="btnDownload" class="secondary" type="button" disabled>ä¸‹è¼‰ mm-notices.json</button>
          <button id="btnClearAll" class="ghost" type="button">æ¸…ç©ºæ¸…å–®</button>
        </div>

        <div class="small" style="margin-top:10px;">
          ä½¿ç”¨æ–¹å¼ï¼šæŒ‰ã€Œç”¢ç”Ÿ JSONã€â†’ã€Œä¸€éµè¤‡è£½ JSONã€â†’ åˆ° GitHub æ‰“é–‹ <span class="mono">mm-notices.json</span> â†’ å…¨é¸è²¼ä¸Šè¦†è“‹ â†’ Commitã€‚
        </div>

        <div style="margin-top:12px;">
          <label>è¼¸å‡ºçš„ JSONï¼ˆå¯ç›´æ¥è²¼åˆ° GitHubï¼‰</label>
          <pre id="jsonOut" class="mono">{}</pre>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- helpers ----------
  function pad2(n){ return String(n).padStart(2,"0"); }
  function toTWISO(dt){
    // produce YYYY-MM-DDTHH:mm:ss+08:00
    const y = dt.getFullYear();
    const m = pad2(dt.getMonth()+1);
    const d = pad2(dt.getDate());
    const hh = pad2(dt.getHours());
    const mm = pad2(dt.getMinutes());
    const ss = pad2(dt.getSeconds());
    return `${y}-${m}-${d}T${hh}:${mm}:${ss}+08:00`;
  }

  function safeTrim(s){ return (s ?? "").toString().trim(); }

  function linesToArray(text){
    return safeTrim(text)
      .split(/\r?\n/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  function setStatus(kind, text){
    const el = document.getElementById("status");
    el.textContent = text;
    el.className = "badge " + (kind === "ok" ? "ok" : "warn");
  }

  function downloadText(filename, text){
    const blob = new Blob([text], {type:"application/json;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 500);
  }

  // ---------- state ----------
  /** @type {Array<any>} */
  let notices = [];

     // ---------- load old mm-notices.json ----------
  const elOldJson = document.getElementById("oldJson");
  const elLoadMode = document.getElementById("loadMode");
  const btnLoadOld = document.getElementById("btnLoadOld");
  const btnLoadFromFile = document.getElementById("btnLoadFromFile");
  const fileOldJson = document.getElementById("fileOldJson");

  function normalizeNotice(n){
    // åªä¿ç•™æˆ‘å€‘ç³»çµ±éœ€è¦çš„æ¬„ä½ï¼Œä¸¦åšåŸºæœ¬æ¸…ç†
    const out = {
      id: safeTrim(n?.id),
      title: safeTrim(n?.title),
      version: safeTrim(n?.version),
      date: safeTrim(n?.date),
      pinned: !!n?.pinned,
      summary: safeTrim(n?.summary),
      bullets: Array.isArray(n?.bullets) ? n.bullets.map(x => safeTrim(x)).filter(Boolean) : undefined,
      details: safeTrim(n?.details),
    };

    // ç§»é™¤ç©ºæ¬„ä½
    if (!out.version) delete out.version;
    if (!out.summary) delete out.summary;
    if (!out.details) delete out.details;
    if (!out.bullets || out.bullets.length === 0) delete out.bullets;

    return out;
  }

  function sortNoticesSmart(arr){
    // ç½®é ‚åœ¨å‰ï¼Œæ—¥æœŸæ–°åœ¨å‰ï¼ˆå­—ä¸² YYYY-MM-DD å¯ç›´æ¥æ¯”ï¼‰
    return arr.slice().sort((a,b) => {
      const ap = a.pinned ? 1 : 0;
      const bp = b.pinned ? 1 : 0;
      if (ap !== bp) return bp - ap;
      const ad = a.date || "";
      const bd = b.date || "";
      if (ad !== bd) return bd.localeCompare(ad);
      return (b.id || "").localeCompare(a.id || "");
    });
  }

  function loadFromParsedJson(parsed, mode){
    if (!parsed || !Array.isArray(parsed.notices)){
      alert("JSON æ ¼å¼ä¸å°ï¼šæ‰¾ä¸åˆ° notices é™£åˆ—ã€‚è«‹ç¢ºèªä½ è²¼çš„æ˜¯ mm-notices.json çš„å®Œæ•´å…§å®¹ã€‚");
      return;
    }

    // schemaVersion é †ä¾¿å¸¶å…¥ï¼ˆgeneratedAt ä»ä»¥ä½ æŒ‰ã€Œç”¢ç”Ÿ JSONã€ç•¶ä¸‹ç‚ºæº–ï¼‰
    if (parsed.schemaVersion != null) {
      elSchema.value = String(parsed.schemaVersion);
    }

    const incoming = parsed.notices
      .map(normalizeNotice)
      .filter(n => n.id && n.title && n.date);

    if (incoming.length === 0){
      alert("èˆŠ JSON è£¡æ²’æœ‰å¯ç”¨çš„å…¬å‘Šï¼ˆè‡³å°‘è¦æœ‰ id/title/dateï¼‰ã€‚");
      return;
    }

    if (mode === "replace"){
      notices = sortNoticesSmart(incoming);
    } else {
      // mergeï¼šåŒ id ä»¥ã€ŒèˆŠ JSONã€ç‚ºæº–ï¼ˆincoming è¦†è“‹ existingï¼‰
      const map = new Map();
      // å…ˆæ”¾ç›®å‰æ¸…å–®
      notices.forEach(n => map.set(n.id, n));
      // å†ç”¨ incoming è¦†è“‹
      incoming.forEach(n => map.set(n.id, n));
      notices = sortNoticesSmart(Array.from(map.values()));
    }

    renderList();
    setStatus("warn", "å·²è¼‰å…¥èˆŠ JSONï¼Œè«‹ç”¢ç”Ÿ JSON");
    btnCopy.disabled = true;
    btnDownload.disabled = true;
  }

  function tryParseJson(text){
    try{
      return JSON.parse(text);
    }catch(err){
      return null;
    }
  }

  btnLoadOld?.addEventListener("click", () => {
    const txt = safeTrim(elOldJson.value);
    if (!txt){
      alert("è«‹å…ˆè²¼ä¸ŠèˆŠç‰ˆ mm-notices.json çš„å…§å®¹ã€‚");
      return;
    }
    const parsed = tryParseJson(txt);
    if (!parsed){
      alert("JSON è§£æå¤±æ•—ï¼šè«‹ç¢ºèªæ ¼å¼æ­£ç¢ºï¼ˆå¯å…ˆåˆ° JSON æ ¼å¼åŒ–ç¶²ç«™æª¢æŸ¥ï¼‰ã€‚");
      return;
    }
    loadFromParsedJson(parsed, elLoadMode.value);
  });

  btnLoadFromFile?.addEventListener("click", () => fileOldJson.click());

  fileOldJson?.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const text = await file.text();
    elOldJson.value = text; // é †ä¾¿æ”¾åˆ° textarea æ–¹ä¾¿ä½ ç•™å­˜
    const parsed = tryParseJson(text);
    if (!parsed){
      alert("æª”æ¡ˆå…§å®¹ä¸æ˜¯åˆæ³• JSONï¼Œè«‹ç¢ºèªä½ é¸åˆ°çš„æ˜¯ mm-notices.jsonã€‚");
      return;
    }
    loadFromParsedJson(parsed, elLoadMode.value);
  });

    // ---------- load old json from URL ----------
  const elOldJsonUrl = document.getElementById("oldJsonUrl");
  const btnLoadFromUrl = document.getElementById("btnLoadFromUrl");

    // ---------- remember url (localStorage) ----------
  const btnSaveUrl = document.getElementById("btnSaveUrl");
  const STORAGE_KEY_NOTICE_URL = "mm_notice_editor_last_url";
  
     // ğŸ§¹ æ¸…é™¤è¨˜ä½çš„ç¶²å€
  const btnClearUrl = document.getElementById("btnClearUrl");

  btnClearUrl?.addEventListener("click", () => {
    const hasSaved = localStorage.getItem(STORAGE_KEY_NOTICE_URL);

    if (!hasSaved){
      alert("ç›®å‰æ²’æœ‰è¨˜ä½ä»»ä½•ç¶²å€ã€‚");
      return;
    }

    if (!confirm("ç¢ºå®šè¦æ¸…é™¤å·²è¨˜ä½çš„ mm-notices.json ç¶²å€å—ï¼Ÿ")) return;

    try{
      localStorage.removeItem(STORAGE_KEY_NOTICE_URL);
      elOldJsonUrl.value = "";
      alert("å·²æ¸…é™¤è¨˜ä½çš„ç¶²å€ ğŸ§¹\n\nä¸‹æ¬¡é–‹å•Ÿå°‡ä¸å†è‡ªå‹•å¡«å…¥ã€‚");
    }catch(err){
      alert("æ¸…é™¤å¤±æ•—ï¼šç€è¦½å™¨å¯èƒ½ä¸å…è¨± localStorageã€‚");
    }
  });

  // é é¢è¼‰å…¥æ™‚ï¼Œè‡ªå‹•å¡«å…¥ä¸Šæ¬¡è¨˜ä½çš„ç¶²å€
  (function restoreSavedUrl(){
    try{
      const saved = localStorage.getItem(STORAGE_KEY_NOTICE_URL);
      if (saved && elOldJsonUrl && !elOldJsonUrl.value){
        elOldJsonUrl.value = saved;
      }
    }catch(e){
      // å¿½ç•¥ localStorage ä¸å¯ç”¨çš„æ¥µç«¯æƒ…æ³
    }
  })();

  // é» ğŸ“Œï¼šè¨˜ä½ç›®å‰è¼¸å…¥çš„ç¶²å€
  btnSaveUrl?.addEventListener("click", () => {
    const url = safeTrim(elOldJsonUrl.value);
    if (!url){
      alert("ç›®å‰æ²’æœ‰ç¶²å€å¯è¨˜ä½ï¼Œè«‹å…ˆè²¼ä¸Š mm-notices.json çš„ç¶²å€ã€‚");
      return;
    }

    try{
      localStorage.setItem(STORAGE_KEY_NOTICE_URL, url);
      alert("å·²è¨˜ä½å¸¸ç”¨ç¶²å€ âœ”\n\nä¸‹æ¬¡æ‰“é–‹å…¬å‘Šå°å¹«æ‰‹æœƒè‡ªå‹•å¡«å…¥ã€‚");
    }catch(err){
      alert("å„²å­˜å¤±æ•—ï¼šç€è¦½å™¨å¯èƒ½ä¸å…è¨± localStorageã€‚");
    }
  });


  function toJinaAiProxy(url){
    // r.jina.ai æœƒæŠŠç¶²å€å…§å®¹è½‰æˆç´”æ–‡å­—ï¼ˆå¯ç¹éè¨±å¤š CORS é™åˆ¶ï¼‰
    // https://r.jina.ai/http(s)://example.com/file.json
    if (url.startsWith("https://")) return "https://r.jina.ai/https://" + url.slice("https://".length);
    if (url.startsWith("http://"))  return "https://r.jina.ai/http://"  + url.slice("http://".length);
    return null;
  }

  


  async function fetchTextSmart(url){
    // å…ˆè©¦ç›´æ¥æŠ“ï¼ˆæœ€å¿«ï¼‰
    try{
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.text();
    }catch(err){
      // å†è©¦ jina ä»£ç†ï¼ˆCORS å¸¸è¦‹æ•‘æ˜Ÿï¼‰
      const proxy = toJinaAiProxy(url);
      if (!proxy) throw err;
      const res2 = await fetch(proxy, { cache: "no-store" });
      if (!res2.ok) throw new Error("Proxy HTTP " + res2.status);
      return await res2.text();
    }
  }

  btnLoadFromUrl?.addEventListener("click", async () => {
    const url = safeTrim(elOldJsonUrl.value);
    if (!url){
      alert("è«‹å…ˆè²¼ä¸Šç¶²å€ï¼Œä¾‹å¦‚ https://miracle-mind.org/mm-notices.json æˆ– GitHub raw é€£çµã€‚");
      return;
    }

    btnLoadFromUrl.disabled = true;
    btnLoadFromUrl.textContent = "è¼‰å…¥ä¸­â€¦";

    try{
      const text = await fetchTextSmart(url);

      // æœ‰äº›é é¢å¯èƒ½å‰å¾Œæœ‰é›œè¨Šï¼ˆä¾‹å¦‚è¢«åŒ…è£æˆæ–‡å­—ï¼‰ï¼Œæˆ‘å€‘åšä¸€æ¬¡ã€ŒæŠ“å‡ºç¬¬ä¸€å€‹ { åˆ°æœ€å¾Œä¸€å€‹ }ã€çš„ä¿éšª
      const start = text.indexOf("{");
      const end = text.lastIndexOf("}");
      const candidate = (start >= 0 && end > start) ? text.slice(start, end + 1) : text;

      elOldJson.value = candidate; // é †ä¾¿å¡«å…¥ textarea æ–¹ä¾¿ä½ ä¿å­˜
      const parsed = tryParseJson(candidate);
      if (!parsed){
        alert("å·²æŠ“åˆ°å…§å®¹ï¼Œä½†è§£ææˆ JSON å¤±æ•—ï¼šè«‹ç¢ºèªè©²ç¶²å€æŒ‡å‘çš„æ˜¯ mm-notices.jsonï¼ˆç´” JSON æª”ï¼‰ã€‚");
        return;
      }

      loadFromParsedJson(parsed, elLoadMode.value);
    }catch(err){
      alert("ç¶²å€è¼‰å…¥å¤±æ•—ï¼š\n" + (err?.message || String(err)) + "\n\nä½ å¯ä»¥æ”¹ç”¨ã€Œä¸Šå‚³æª”æ¡ˆã€æˆ–ã€Œè²¼ä¸Šå…§å®¹ã€è¼‰å…¥ã€‚");
    }finally{
      btnLoadFromUrl.disabled = false;
      btnLoadFromUrl.textContent = "ä¸€éµè¼‰å…¥";
    }
  });

  // ---------- DOM ----------
  const elSchema = document.getElementById("schemaVersion");
  const elGenAt = document.getElementById("generatedAt");

  const elId = document.getElementById("id");
  const elTitle = document.getElementById("title");
  const elVersion = document.getElementById("version");
  const elDate = document.getElementById("date");
  const elPinned = document.getElementById("pinned");
  const elSummary = document.getElementById("summary");
  const elBullets = document.getElementById("bullets");
  const elDetails = document.getElementById("details");

  const elList = document.getElementById("noticeList");
  const elJson = document.getElementById("jsonOut");

  const btnAdd = document.getElementById("btnAdd");
  const btnReset = document.getElementById("btnReset");
  const btnSeed = document.getElementById("btnSeed");

  // --- è‡ªå‹•ç”¢ç”Ÿå…¬å‘Š IDï¼ˆæ—¥æœŸ + æµæ°´è™Ÿï¼‰ ---
  const btnAutoId = document.getElementById("btnAutoId");

  btnAutoId.addEventListener("click", () => {
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = pad2(now.getMonth() + 1);
    const dd = pad2(now.getDate());
    const today = `${yyyy}-${mm}-${dd}`;

  // æ‰¾å‡ºä»Šå¤©å·²å­˜åœ¨çš„æµæ°´è™Ÿ
  const todayIds = notices
    .map(n => n.id)
    .filter(id => id && id.startsWith(`board_${today}_`));

  let nextSeq = 1;
  if (todayIds.length > 0) {
    const nums = todayIds
      .map(id => Number(id.split("_").pop()))
      .filter(n => !isNaN(n));
    if (nums.length > 0) {
      nextSeq = Math.max(...nums) + 1;
    }
  }

  elId.value = `board_${today}_${pad2(nextSeq)}`;
});



  const btnGenerate = document.getElementById("btnGenerate");
  const btnCopy = document.getElementById("btnCopy");
  const btnDownload = document.getElementById("btnDownload");
  const btnClearAll = document.getElementById("btnClearAll");

  // default date = today (local)
  (function init(){
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = pad2(now.getMonth()+1);
    const dd = pad2(now.getDate());
    elDate.value = `${yyyy}-${mm}-${dd}`;
  })();

  function renderList(){
    elList.innerHTML = "";
    if (notices.length === 0){
      const empty = document.createElement("div");
      empty.className = "small";
      empty.style.marginTop = "10px";
      empty.textContent = "ï¼ˆç›®å‰æ¸…å–®æ˜¯ç©ºçš„ã€‚å…ˆç”¨å·¦å´è¡¨å–®åŠ å…¥å…¬å‘Šã€‚ï¼‰";
      elList.appendChild(empty);
      return;
    }

    notices.forEach((n, idx) => {
      const card = document.createElement("div");
      card.className = "listCard";

      const head = document.createElement("div");
      head.className = "noticeHead";

      const title = document.createElement("div");
      title.className = "noticeTitle";
      title.textContent = n.title || "(æœªå¡«æ¨™é¡Œ)";

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "8px";
      right.style.alignItems = "center";

      if (n.pinned){
        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = "ç½®é ‚";
        right.appendChild(pill);
      }

      const btnUp = document.createElement("button");
      btnUp.type = "button";
      btnUp.textContent = "â†‘";
      btnUp.className = "ghost";
      btnUp.style.padding = "6px 10px";
      btnUp.onclick = () => {
        if (idx === 0) return;
        const t = notices[idx-1];
        notices[idx-1] = notices[idx];
        notices[idx] = t;
        renderList();
      };

      const btnDown = document.createElement("button");
      btnDown.type = "button";
      btnDown.textContent = "â†“";
      btnDown.className = "ghost";
      btnDown.style.padding = "6px 10px";
      btnDown.onclick = () => {
        if (idx === notices.length-1) return;
        const t = notices[idx+1];
        notices[idx+1] = notices[idx];
        notices[idx] = t;
        renderList();
      };

      const btnDel = document.createElement("button");
      btnDel.type = "button";
      btnDel.textContent = "åˆªé™¤";
      btnDel.className = "secondary";
      btnDel.style.padding = "6px 10px";
      btnDel.onclick = () => {
        notices.splice(idx, 1);
        renderList();
        setStatus("warn", "å°šæœªç”¢ç”Ÿ JSON");
        btnCopy.disabled = true;
        btnDownload.disabled = true;
      };

      right.appendChild(btnUp);
      right.appendChild(btnDown);
      right.appendChild(btnDel);

      head.appendChild(title);
      head.appendChild(right);
      card.appendChild(head);

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `id: ${n.id} ï½œ version: ${n.version || "â€”"} ï½œ date: ${n.date || "â€”"}`;
      card.appendChild(meta);

      if (n.summary){
        const s = document.createElement("div");
        s.className = "small";
        s.style.marginTop = "8px";
        s.textContent = n.summary;
        card.appendChild(s);
      }

      elList.appendChild(card);
    });
  }

  function resetForm(){
    elId.value = "";
    elTitle.value = "";
    elVersion.value = "v1.0.0";
    // date keep
    elPinned.checked = false;
    elSummary.value = "";
    elBullets.value = "";
    elDetails.value = "";
  }

  function validateNotice(n){
    if (!n.id) return "è«‹å¡« idï¼ˆå»ºè­°ç”¨æ—¥æœŸ+æµæ°´è™Ÿï¼Œä¸”æ¯å‰‡å”¯ä¸€ï¼‰";
    if (!n.title) return "è«‹å¡« title";
    if (!n.date) return "è«‹é¸ date";
    // version can be empty but recommended
    return "";
  }

  btnAdd.addEventListener("click", (e) => {
    e.preventDefault();

    const notice = {
      id: safeTrim(elId.value),
      title: safeTrim(elTitle.value),
      version: safeTrim(elVersion.value),
      date: safeTrim(elDate.value),
      pinned: !!elPinned.checked,
      summary: safeTrim(elSummary.value),
      bullets: linesToArray(elBullets.value),
      details: safeTrim(elDetails.value),
    };

    // remove empty optional fields for cleanliness
    if (!notice.version) delete notice.version;
    if (!notice.summary) delete notice.summary;
    if (!notice.details) delete notice.details;
    if (!notice.bullets || notice.bullets.length === 0) delete notice.bullets;

    const err = validateNotice(notice);
    if (err){
      alert(err);
      return;
    }

    // id uniqueness
    if (notices.some(x => x.id === notice.id)){
      alert("é€™å€‹ id å·²ç¶“å­˜åœ¨æ–¼æ¸…å–®ä¸­ï¼Œè«‹æ›ä¸€å€‹æ–°çš„ idã€‚");
      return;
    }

    notices.unshift(notice); // default: newest on top
    renderList();
    resetForm();
    setStatus("warn", "å·²æ›´æ–°æ¸…å–®ï¼Œè«‹ç”¢ç”Ÿ JSON");
    btnCopy.disabled = true;
    btnDownload.disabled = true;
  });

  btnReset.addEventListener("click", () => resetForm());

  btnSeed.addEventListener("click", () => {
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = pad2(now.getMonth()+1);
    const dd = pad2(now.getDate());
    elId.value = `board_${yyyy}-${mm}-${dd}_01`;
    elTitle.value = "å…¬å‘Šï½œç¯„ä¾‹å…¬å‘Šï¼ˆè«‹æ”¹æˆä½ çš„å…§å®¹ï¼‰";
    elVersion.value = "v1.0.0";
    elDate.value = `${yyyy}-${mm}-${dd}`;
    elPinned.checked = true;
    elSummary.value = "é€™æ˜¯ä¸€æ®µçŸ­æ‘˜è¦ï¼ˆåˆ—è¡¨æœƒçœ‹åˆ°ï¼‰";
    elBullets.value = "ç¬¬ä¸€é»é‡é»\nç¬¬äºŒé»é‡é»";
    elDetails.value = "é€™è£¡å¯ä»¥æ”¾æ¯”è¼ƒé•·çš„å…§å®¹ï¼ˆå±•é–‹å¾Œé¡¯ç¤ºï¼‰ã€‚";
  });

  btnClearAll.addEventListener("click", () => {
    if (!confirm("ç¢ºå®šè¦æ¸…ç©ºå³å´å…¬å‘Šæ¸…å–®å—ï¼Ÿ")) return;
    notices = [];
    renderList();
    elJson.textContent = "{}";
    setStatus("warn", "å°šæœªç”¢ç”Ÿ JSON");
    btnCopy.disabled = true;
    btnDownload.disabled = true;
  });

  btnGenerate.addEventListener("click", () => {
    const schemaVersion = Number(safeTrim(elSchema.value)) || 1;
    const generatedAt = toTWISO(new Date());
    elGenAt.value = generatedAt;

    const output = {
      schemaVersion,
      generatedAt,
      notices
    };

    const pretty = JSON.stringify(output, null, 2);
    elJson.textContent = pretty;

    setStatus("ok", "JSON å·²ç”¢ç”Ÿ");
    btnCopy.disabled = false;
    btnDownload.disabled = false;
  });

  btnCopy.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(elJson.textContent);
      setStatus("ok", "å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ âœ…");
      setTimeout(() => setStatus("ok","JSON å·²ç”¢ç”Ÿ"), 1200);
    }catch{
      alert("è¤‡è£½å¤±æ•—ï¼šç€è¦½å™¨å¯èƒ½é˜»æ“‹ clipboardã€‚ä½ å¯ä»¥æ‰‹å‹•å…¨é¸å³å´ JSON å†è¤‡è£½ã€‚");
    }
  });

  btnDownload.addEventListener("click", () => {
    downloadText("mm-notices.json", elJson.textContent);
  });

  // init
  renderList();
</script>
</body>
</html>
